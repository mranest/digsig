package net.sf.dsig.verify;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.security.cert.CertificateFactory;
import java.security.cert.TrustAnchor;
import java.security.cert.X509Certificate;
import java.util.HashSet;
import java.util.Set;

import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import junit.framework.TestCase;

import org.apache.xml.security.signature.ObjectContainer;
import org.apache.xml.security.utils.Base64;
import org.w3c.dom.Element;

public class XmldsigVerifierTest extends TestCase {

	/*
	public void testVerify() throws Exception {
		XmldsigVerifier v = new XmldsigVerifier();
		v.setCrlHelper(X509CRLHelperTest.getCrlHelper());
		v.setOcspHelper(OCSPHelperTest.getOcspHelper());

		try {
			v.isValid();
			fail("Unsupported operation exception not raised");
		} catch (UnsupportedOperationException ignored) {
		}

		v.initEnvelopingSignature(getClass().getResourceAsStream(
				"/sample-xmldsig.xml"));

		CertificateFactory cf = CertificateFactory.getInstance("X.509");
		X509Certificate certificate = (X509Certificate) cf
				.generateCertificate(getClass()
						.getResourceAsStream("/root.cer"));
		TrustAnchor ta = new TrustAnchor(certificate, null);
		Set trustAnchors = new HashSet();
		trustAnchors.add(ta);

		v.setTrustAnchors(trustAnchors);

		// No exceptions expected
		assertTrue(v.isCertificatePathValid());
		assertTrue(v.isValid());

		assertTrue(v.verify());
	}
	*/

	private String utf8Signature = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PFNpZ25hdHVyZSB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PFNpZ25lZEluZm8+PENhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI3JzYS1zaGExIi8+PFJlZmVyZW5jZSBVUkk9IiNmb3JtRGF0YSI+PFRyYW5zZm9ybXM+PFRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvVHJhbnNmb3Jtcz48RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI3NoYTEiLz48RGlnZXN0VmFsdWU+WVl3cVU2MjdGV3lFK0FTL3JSTFVNK0Y2NC93PTwvRGlnZXN0VmFsdWU+PC9SZWZlcmVuY2U+PFJlZmVyZW5jZSBVUkk9IiNub25jZSI+PFRyYW5zZm9ybXM+PFRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvVHJhbnNmb3Jtcz48RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI3NoYTEiLz48RGlnZXN0VmFsdWU+WmF3UXF1eitoT0FJbWt2eVlrTUJITStPM0ZBPTwvRGlnZXN0VmFsdWU+PC9SZWZlcmVuY2U+PC9TaWduZWRJbmZvPjxTaWduYXR1cmVWYWx1ZT5wb1lDRWtnTmZFWlMvSG4xSlZYekdMZm5MOXhtT0NObjBiY2E1Zzg2MmVPbTlwUXgrMnFiKzlQR1c4blN2bXJOQzY1NUZnNFd5N2FYDQp5VnFZUnJNWHFJUEdTTTU0R0hlWkRveDBvYVMvVDB3eG1VdHBXS2VKQ3FWWEZoQ3VZTGZya0FjMitKU2paN0pLV0llU3JRdXExNUxqDQpZTUZqQkxlUWF3cTNJNGJJdkIwPTwvU2lnbmF0dXJlVmFsdWU+PEtleUluZm8+PFg1MDlEYXRhPjxYNTA5Q2VydGlmaWNhdGU+TUlJRW5EQ0NCQVdnQXdJQkFnSVFJTU9rbUlPR3VaSVVJc2h3WXVFd3JEQU5CZ2txaGtpRzl3MEJBUVVGQURDQm5ERUxNQWtHQTFVRQ0KQmhNQ1IxSXhJekFoQmdOVkJBb1RHa1ZHUnlCRmRYSnZZbUZ1YXlCRmNtZGhjMmxoY3lCQkxrVXVNUjh3SFFZRFZRUUxFeFpXWlhKcA0KVTJsbmJpQlVjblZ6ZENCT1pYUjNiM0pyTVI4d0hRWURWUVFMRXhaR1QxSWdWRVZUVkNCUVZWSlFUMU5GVXlCUFRreFpNU1l3SkFZRA0KVlFRREV4MUZSa2NnUlhWeWIySmhibXNnUlhKbllYTnBZWE1nVkVWVFZDQkRRVEFlRncweE1EQTNNVFF3TURBd01EQmFGdzB4TVRBMw0KTVRReU16VTVOVGxhTUlJQkFURWJNQmtHQTFVRUN4UVNRV3hwWVhNZ0xTQlRkWEJsY2tGc2FXRnpNUXN3Q1FZRFZRUUdFd0pIVWpFZg0KTUIwR0ExVUVDeFFXUms5U0lGUkZVMVFnVUZWU1VFOVRSVk1nVDA1TVdURXhNQzhHQTFVRUN4UW9WR1Z5YlhNZ2IyWWdkWE5sSUdGMA0KSUhObFl5NWhaR0ZqYjIwdVkyOXRMM0p3WVNBb1l5a3dNekVqTUNFR0ExVUVDaFFhUlVaSElFVjFjbTlpWVc1cklFVnlaMkZ6YVdGeg0KSUVFdVJTNHhHREFXQmdOVkJBd1VEMU4xY0dWeVVISnZaM0poYlcxbGNqRVRNQkVHQTFVRUJCTUtSMlZ2Y21kcFlXUnBjekVRTUE0Rw0KQTFVRUtoTUhRVzVsYzNScGN6RWJNQmtHQTFVRUF4TVNRVzVsYzNScGN5QkhaVzl5WjJsaFpHbHpNSUdmTUEwR0NTcUdTSWIzRFFFQg0KQVFVQUE0R05BRENCaVFLQmdRQ3FlTlBpcnQvTzJ0Q1JaS3pNdjZ6MTBHR0tGTzFPdTZtWW0zcDFzQXJYNHRzTXFQb0FjanJmOVdhbQ0KOUE3TjlTNE1ORXdEampFVzBoOHhzaVBlTWdFV3drUVd5VEl2K2Q4Nk9tS3k2eVRiU2VnSkFVT25TMkgzeEdieXlZZk96OVVacEZxTg0KdURqWXUwc0owK2U0eDhHNGVkalpON1JtREZtZElTNUtNaWgrandJREFRQUJvNElCZFRDQ0FYRXdDUVlEVlIwVEJBSXdBREFMQmdOVg0KSFE4RUJBTUNCZUF3V3dZRFZSMGdCRlF3VWpBM0JndGdoa2dCaHZoRkFRY1hBakFvTUNZR0NDc0dBUVVGQndJQkZocG9kSFJ3Y3pvdg0KTDNObFl5NWhaR0ZqYjIwdVkyOXRMM0p3WVRBTkJndGdoa2dCaHZoRkFRY3NBakFJQmdZRUFJc3dBUUV3WWdZRFZSMGZCRnN3V1RCWA0Kb0ZXZ1U0WlJhSFIwY0RvdkwyTnliQzEwWlhOMExtRmtZV052YlM1amIyMHZSVVpIUlhWeWIySmhibXRGY21kaGMybGhjMEZGUms5Uw0KVkVWVFZGQlZVbEJQVTBWVFQwNU1XUzlNWVhSbGMzUkRVa3d1WTNKc01CRUdDV0NHU0FHRytFSUJBUVFFQXdJSGdEQVJCZ3BnaGtnQg0KaHZoRkFRWUpCQU1CQWY4d0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3SUdDQ3NHQVFVRkJ3TUVNQmdHQ0NzR0FRVUZCd0VEQkF3dw0KQ2pBSUJnWUVBSTVHQVFFd053WUlLd1lCQlFVSEFRRUVLekFwTUNjR0NDc0dBUVVGQnpBQmhodG9kSFJ3T2k4dmIyTnpjQzEwWlhOMA0KTG1Ga1lXTnZiUzVqYjIwd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ1lFQXNIUCtCY1B5WVhUOEVtMy9ObGZMYnNyYS8yM1JrVjJLWXdsSg0KR3VkMkt5b2lGSnRwdHFMM2ZwTURPWmlPTmVrVW11RU1SZ3hOUm4xNS81eWVWbitTWDN4TlBCNGI2R0VJdU9TUjNqUGNDbXJlK0d4RA0KcnhBYWVLTWRMMDNCQkNLOFhIRHN2RUMzcWIrQkMzRk80cXYwemNmS3NiUWRjNTZHZ1FtK05GMXFiQ009PC9YNTA5Q2VydGlmaWNhdGU+PFg1MDlDZXJ0aWZpY2F0ZT5NSUlETHpDQ0FwaWdBd0lCQWdJUUtqOW93eDJPakE0OFhGVXcyMDNpbHpBTkJna3Foa2lHOXcwQkFRVUZBREI1TVJRd0VnWURWUVFLDQpFd3RCWkdGamIyMGdVeTVCTGpFZk1CMEdBMVVFQ3hNV1ZtVnlhVk5wWjI0Z1ZISjFjM1FnVG1WMGQyOXlhekVmTUIwR0ExVUVDeE1XDQpSazlTSUZSRlUxUWdVRlZTVUU5VFJWTWdUMDVNV1RFZk1CMEdBMVVFQXhNV1FXUmhZMjl0SUVOc1lYTnpJRElnVkVWVFZDQkRRVEFlDQpGdzB3TmpBNU1qVXdNREF3TURCYUZ3MHhNVEE1TWpReU16VTVOVGxhTUlHY01Rc3dDUVlEVlFRR0V3SkhVakVqTUNFR0ExVUVDaE1hDQpSVVpISUVWMWNtOWlZVzVySUVWeVoyRnphV0Z6SUVFdVJTNHhIekFkQmdOVkJBc1RGbFpsY21sVGFXZHVJRlJ5ZFhOMElFNWxkSGR2DQpjbXN4SHpBZEJnTlZCQXNURmtaUFVpQlVSVk5VSUZCVlVsQlBVMFZUSUU5T1RGa3hKakFrQmdOVkJBTVRIVVZHUnlCRmRYSnZZbUZ1DQpheUJGY21kaGMybGhjeUJVUlZOVUlFTkJNSUdmTUEwR0NTcUdTSWIzRFFFQkFRVUFBNEdOQURDQmlRS0JnUURCa2YyNHRtaldEcUtIDQpFMndnbVlIbTJXVTNiTEM4ZTRVYmREampQRy9mb2l0ZTFtSjhUVGZ3aVZoTm1OUmtXWk96WkRRUVpRSUxRMXpIbG5zQWxaaFhrUjNwDQpOYjJzc3ErYi9pdGpGTlJJY0RRUldEK1d3M0dTZ0tsNmQ2ZmxoZWUrRlU5eEIveGRQdDhWUU9Eci81WmlwTzZkUFpOUjNWM080M2MwDQpEOHQzOHdJREFRQUJvNEdUTUlHUU1CSUdBMVVkRXdFQi93UUlNQVlCQWY4Q0FRQXdPQVlEVlIwZkJERXdMekF0b0N1Z0tZWW5hSFIwDQpjRG92TDJOeWJDMTBaWE4wTG1Ga1lXTnZiUzV1WlhRdll6SjBaWE4wWTJFdVkzSnNNQTRHQTFVZER3RUIvd1FFQXdJQkJqQVJCZ2xnDQpoa2dCaHZoQ0FRRUVCQU1DQVFZd0hRWURWUjBPQkJZRUZNcnMvTi81VnBKS21TcUhFR0RaQ3l5RzhCcjlNQTBHQ1NxR1NJYjNEUUVCDQpCUVVBQTRHQkFLd1ArejdhdnpYYnJWb2NhUXVncURSSXliYnh2WW9CRm9oS2xSNmdKR01BcFdPWHdSMU9waHMyZUlJMjdRdkxwS0ViDQp2SzhlOEdQZitSeFpYaDVDRWNSWHhMcW5Ob0YxQ0VsSU9DQUk0dE9tVURJN2d4L09nTENsVHBnU0g0dGNxMVpreWVWSG5acW45dnlWDQpFeXY5YlE0RlkzdDZYMWsyVXE3MHZXSWU2djRnPC9YNTA5Q2VydGlmaWNhdGU+PFg1MDlDZXJ0aWZpY2F0ZT5NSUlERERDQ0FuV2dBd0lCQWdJUU1GNDYzS3NJUVp3RWtZT0E2NitpNkRBTkJna3Foa2lHOXcwQkFRVUZBRENCOERFTE1Ba0dBMVVFDQpCaE1DVlZNeEZ6QVZCZ05WQkFvVERsWmxjbWxUYVdkdUxDQkpibU11TVVFd1B3WURWUVFMRXpoRGJHRnpjeUF5SUZSRlUxUWdVSFZpDQpiR2xqSUZCeWFXMWhjbmtnUTJWeWRHbG1hV05oZEdsdmJpQkJkWFJvYjNKcGRIa2dMU0JITWpGRE1FRUdBMVVFQ3hNNlZHVnliWE1nDQpiMllnZFhObElHRjBJR2gwZEhCek9pOHZkM2QzTG5abGNtbHphV2R1TG1OdmJTOWpjSE12ZEdWemRHTmhMeUFvWXlrd01qRWZNQjBHDQpBMVVFQ3hNV1ZtVnlhVk5wWjI0Z1ZISjFjM1FnVG1WMGQyOXlhekVmTUIwR0ExVUVDeE1XUm05eUlGUmxjM1FnVUhWeWNHOXpaWE1nDQpUMjVzZVRBZUZ3MHdNakEyTWpZd01EQXdNREJhRncweE5UQTRNVGt5TXpVNU5UbGFNSGt4RkRBU0JnTlZCQW9UQzBGa1lXTnZiU0JUDQpMa0V1TVI4d0hRWURWUVFMRXhaV1pYSnBVMmxuYmlCVWNuVnpkQ0JPWlhSM2IzSnJNUjh3SFFZRFZRUUxFeFpHVDFJZ1ZFVlRWQ0JRDQpWVkpRVDFORlV5QlBUa3haTVI4d0hRWURWUVFERXhaQlpHRmpiMjBnUTJ4aGMzTWdNaUJVUlZOVUlFTkJNSUdmTUEwR0NTcUdTSWIzDQpEUUVCQVFVQUE0R05BRENCaVFLQmdRQ3o5d09FbS9LbDBiVUZFTEszV2dQS0kwNWhuaFlENjJPZEhxa245bVJmeW5ETlcvK3puYlFlDQpFVlZUMHpxditzN0ZKZzYwR0oyL29JUVZSMzROaFdVOU1KOWF5THVyWTBDNDlhUTFteVRZUmYxZUhlSlhQMndnOWxBV2lMTGNvWm5kDQpNN0R4VHZwMktRMElTOC8zWUo1d21RczRORzViVE1obVJDWnFKZjFHUndJREFRQUJveDB3R3pBTEJnTlZIUThFQkFNQ0FRWXdEQVlEDQpWUjBUQkFVd0F3RUIvekFOQmdrcWhraUc5dzBCQVFVRkFBT0JnUUNxMkQ3dEJyR0I4dXRlZ2txQmZ5c1hLNlFhSHl5bXZhc3lZMlZBDQp4SnhZTUpJdC9IbS9PbHRaS0tMVmI2dm9NNktaY1dvbWFnYzY5ZDlnT2NEakk1QnZ4TG1QeHEwOTBRYW01aXFOS1orb2haZENMbFVaDQp4K0sxM3FaQ0RKeTUwT3EwdUNYMzlLcDZHY2VXMGlMdFM1VmRJQzhmY2VVM2NnWWNzT2dHaGJZZmFBPT08L1g1MDlDZXJ0aWZpY2F0ZT48WDUwOUNlcnRpZmljYXRlPk1JSURZRENDQXNrQ0VGR1BISjVtbzFqdTJHSS8zYStMemowd0RRWUpLb1pJaHZjTkFRRUZCUUF3Z2ZBeEN6QUpCZ05WQkFZVEFsVlQNCk1SY3dGUVlEVlFRS0V3NVdaWEpwVTJsbmJpd2dTVzVqTGpGQk1EOEdBMVVFQ3hNNFEyeGhjM01nTWlCVVJWTlVJRkIxWW14cFl5QlENCmNtbHRZWEo1SUVObGNuUnBabWxqWVhScGIyNGdRWFYwYUc5eWFYUjVJQzBnUnpJeFF6QkJCZ05WQkFzVE9sUmxjbTF6SUc5bUlIVnoNClpTQmhkQ0JvZEhSd2N6b3ZMM2QzZHk1MlpYSnBjMmxuYmk1amIyMHZZM0J6TDNSbGMzUmpZUzhnS0dNcE1ESXhIekFkQmdOVkJBc1QNCkZsWmxjbWxUYVdkdUlGUnlkWE4wSUU1bGRIZHZjbXN4SHpBZEJnTlZCQXNURmtadmNpQlVaWE4wSUZCMWNuQnZjMlZ6SUU5dWJIa3cNCkhoY05NREl3TkRJd01EQXdNREF3V2hjTk1qZ3dPREF4TWpNMU9UVTVXakNCOERFTE1Ba0dBMVVFQmhNQ1ZWTXhGekFWQmdOVkJBb1QNCkRsWmxjbWxUYVdkdUxDQkpibU11TVVFd1B3WURWUVFMRXpoRGJHRnpjeUF5SUZSRlUxUWdVSFZpYkdsaklGQnlhVzFoY25rZ1EyVnkNCmRHbG1hV05oZEdsdmJpQkJkWFJvYjNKcGRIa2dMU0JITWpGRE1FRUdBMVVFQ3hNNlZHVnliWE1nYjJZZ2RYTmxJR0YwSUdoMGRIQnoNCk9pOHZkM2QzTG5abGNtbHphV2R1TG1OdmJTOWpjSE12ZEdWemRHTmhMeUFvWXlrd01qRWZNQjBHQTFVRUN4TVdWbVZ5YVZOcFoyNGcNClZISjFjM1FnVG1WMGQyOXlhekVmTUIwR0ExVUVDeE1XUm05eUlGUmxjM1FnVUhWeWNHOXpaWE1nVDI1c2VUQ0JuekFOQmdrcWhraUcNCjl3MEJBUUVGQUFPQmpRQXdnWWtDZ1lFQTYwZUhSWHBPMFZUZHFXcm9lYWpEWU10YTlTRFZJT0d2VU9HU044MS9PMVRZanpqSEdnSFENCnZXQzAwSjc5ZFkrVTJrc2pHeE5vc1hiSFp6MGpzV1ZjRGdyR0ltZGYwSHhxLzZYQWtOdDBzV29TN0hTLzVhMFA3a1Iwa3RmamV1T0UNCmdabmlXeUlqdVFyVW4vb0tZRnhQUHhnMURSNVhSQ2tHUVFWZ0pQdFVmUThDQXdFQUFUQU5CZ2txaGtpRzl3MEJBUVVGQUFPQmdRRFINClQrQUQxSEZGQ2VvL3h6MlkyYXo3eXROcW9SaDBCNHNPNVZQRHJlU3kyNXZyV2hVOXE3OWJ1N3R4eFFIWittK3h2blgrckJ3eU1LQmcNCndGM1ZQZFVtemhON2tpcmU2bTluSTRzLytrVzd3dGJXclpkdUNIOEpNZWlKUmUyeFlTMUVGZGE3bzdXeVE5M0RNZXBaSHF0K0FPK2sNCnVZblcxTWlPUmZsV2N4U2crUT09PC9YNTA5Q2VydGlmaWNhdGU+PC9YNTA5RGF0YT48L0tleUluZm8+PE9iamVjdCBFbmNvZGluZz0iVVRGLTgiIElkPSJmb3JtRGF0YSI+PGZvcm0gaWQ9ImZvcm0xIiBuYW1lPSJmb3JtMSI+PHNlbGVjdCBtdWx0aXBsZT0iZmFsc2UiIG5hbWU9ImFjY291bnQiPjxvcHRpb24gc2VsZWN0ZWQ9InRydWUiIHZhbHVlPSIxMjM0NTY3ODkwIj5TYXZpbmdzOiAxMjM0NTY3ODkwPC9vcHRpb24+PC9zZWxlY3Q+PGlucHV0IG5hbWU9ImFtb3VudCIgdHlwZT0idGV4dCIgdmFsdWU9InNkZiIvPjxpbnB1dCBjaGVja2VkPSJ0cnVlIiBuYW1lPSJjaGVjayIgdHlwZT0iY2hlY2tib3giIHZhbHVlPSIyIi8+PGlucHV0IGNoZWNrZWQ9InRydWUiIG5hbWU9ImNoZWNrIiB0eXBlPSJjaGVja2JveCIgdmFsdWU9IjMiLz48c2VsZWN0IG11bHRpcGxlPSJmYWxzZSIgbmFtZT0iY2VydGlmaWNhdGVzIj48b3B0aW9uIHNlbGVjdGVkPSJ0cnVlIiB2YWx1ZT0iQW5lc3RpcyBHZW9yZ2lhZGlzLTIzNzM4NTQ5Ij5TdXBlckFsaWFzIC0gQW5lc3RpcyBHZW9yZ2lhZGlzPC9vcHRpb24+PC9zZWxlY3Q+PC9mb3JtPjwvT2JqZWN0PjxPYmplY3QgRW5jb2Rpbmc9IlVURi04IiBJZD0ibm9uY2UiPjx2YWx1ZT50ZXN0X25vbmNlPC92YWx1ZT48L09iamVjdD48L1NpZ25hdHVyZT4=";
	
	public void testUSignature() throws Exception {
		InputStream is = new ByteArrayInputStream(Base64.decode(utf8Signature.getBytes()));
		XmldsigVerifier v = new XmldsigVerifier();
		v.setCrlHelper(X509CRLHelperTest.getCrlHelper());
		v.setOcspHelper(OCSPHelperTest.getOcspHelper());

		v.initEnvelopingSignature(is);
		
		ObjectContainer[] objectContainers = v.getObjectContainers();
		for (int i=0; i<objectContainers.length; i++) {
			ObjectContainer each = objectContainers[i];
			Element element = each.getElement();
			Transformer transformer = TransformerFactory.newInstance().newTransformer();
			transformer.transform(new DOMSource(element), new StreamResult(System.out));
			System.out.println();
		}
		
		CertificateFactory cf = CertificateFactory.getInstance("X.509");
		X509Certificate certificate = (X509Certificate) cf
				.generateCertificate(getClass()
						.getResourceAsStream("/root.cer"));
		TrustAnchor ta = new TrustAnchor(certificate, null);
		Set trustAnchors = new HashSet();
		trustAnchors.add(ta);

		v.setTrustAnchors(trustAnchors);

		assertTrue(v.isCertificatePathValid());
		assertTrue(v.isValid());

		assertTrue(v.verify());
	}

}
